#!/usr/bin/env python3
import sys
import importlib.util
from pathlib import Path

def main():
    # Get the directory where this script lives (resolve symlinks)
    script_path = Path(__file__).resolve()
    script_dir = script_path.parent
    modules_dir = script_dir / "modules"
    
    # Parse command line arguments
    if len(sys.argv) < 2:
        print("Usage: post -<command> [args...]")
        print("\nAvailable commands:")
        print("  -cut         Extract and process video cuts")
        print("  -tighten     Remove silence from video")
        print("  -transcribe  Generate word-level timestamps")
        print("  -essay       Generate essay/transcript from timestamps")
        print("  -captions    Add captions to video")
        print("  -endcard     Add endcard to video")
        print("  -stitch      Stitch multiple videos together")
        sys.exit(1)
    
    # Get the command (first argument, without the leading -)
    command_arg = sys.argv[1]
    if not command_arg.startswith("-"):
        print(f"Error: Command must start with '-' (got: {command_arg})")
        sys.exit(1)
    
    command = command_arg[1:]  # Remove the leading -
    remaining_args = sys.argv[2:]  # Arguments to pass to the module
    
    # Build the path to the module file
    module_path = modules_dir / f"{command}.py"
    
    if not module_path.exists():
        print(f"Error: Unknown command '{command}'")
        print(f"Expected module file: {module_path}")
        sys.exit(1)
    
    # Add modules directory to sys.path so modules can import from each other
    if str(modules_dir) not in sys.path:
        sys.path.insert(0, str(modules_dir))
    
    # Dynamically import the module
    spec = importlib.util.spec_from_file_location(command, module_path)
    if spec is None or spec.loader is None:
        print(f"Error: Could not load module from {module_path}")
        sys.exit(1)
    
    module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(module)
    
    # Check if the module has a run() function
    if not hasattr(module, "run"):
        print(f"Error: Module '{command}' does not have a run() function")
        sys.exit(1)
    
    # Call the module's run() function with remaining arguments
    module.run(remaining_args)

if __name__ == "__main__":
    main()

